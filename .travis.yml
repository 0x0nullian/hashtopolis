language: php
php:
  - '7.0'
services:
  - mysql
install:
  - sudo apt update -qq
  - sudo apt install -y apache2 libapache2-mod-fastcgi
  # enable php-fpm
  - sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - sudo a2enmod rewrite actions fastcgi alias
  - echo "cgi.fix_pathinfo = 1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - sudo sed -i -e "s,www-data,travis,g" /etc/apache2/envvars
  - sudo chown -R travis:travis /var/lib/apache2/fastcgi
  # prepare hashtopolis
  - sudo rm -rf /var/www/html/hashtopolis
  - sudo git clone https://github.com/s3inlc/hashtopolis /var/www/html/hashtopolis
  - sudo /bin/bash ci/files/prepare.sh
  - php -f ci/server/setup.php $TRAVIS_BRANCH
  - sudo cp -f ci/files/apache.conf /etc/apache2/sites-available/000-default.conf
  - sudo service apache2 restart

script:
  - php -f ci/run.php master