{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}
<h2>Tasks ([[sizeof([[taskList]])]])</h2>
{%TEMPLATE->struct/messages%}
<div style='overflow: auto;'>
	{{IF [[login.getLevel()]] >= [[$DAccessLevel::SUPERUSER]]}}
		<form style ='float: left; padding-right: 5px;' action="tasks.php" class='form-inline' method="POST" onSubmit="if (!confirm('Really delete all finished tasks?')) return false;">
			<input type='hidden' name='action' value='[[$DTaskAction::DELETE_FINISHED]]'>
			<input type="hidden" name="csrf" value="[[csrf]]">
			<input type="submit" value="Delete finished" class='btn btn-default'>
		</form>
	{{ENDIF}}
	{%TEMPLATE->tasks/autorefresh%}
	<br>
</div>
<br>
<div class="panel panel-default">
	<table class="table table-bordered table-nonfluid">
		<tr>
			<th>ID</th>
			<th>Name</th>
			<th>Hashlist</th>
			<th>Chunks</th>
			<th>Dispatched</th>
			<th>Searched</th>
			<th>Cracked</th>
			<th>Agents</th>
			<th>Files</th>
			<th>Task Priority</th>
			<th>Action</th>
		</tr>
		{{FOREACH set;[[taskList]]}}
			{{IF [[set.getVal('taskType')]] == [[$DTaskTypes::NORMAL]]}}
				<!-- normal task -->
				<tr>
          <td {{IF [[set.getVal('hasColor')]]}}style="background-color: #[[set.getVal('color')]]"{{ENDIF}}>
            {{IF [[login.getLevel()]] >= 5}}
              <a href="tasks.php?id=[[set.getVal('taskId')]]">[[set.getVal('taskId')]]</a>
            {{ELSE}}
              [[set.getVal('taskId')]]
            {{ENDIF}}
          </td>
          <td title="[[htmlentities([[set.getVal('attackCmd')]], ENT_QUOTES, 'UTF-8')]]">
            {{IF [[login.getLevel()]] >= 5}}
              <a href="tasks.php?id=[[set.getVal('taskId')]]">[[set.getVal('taskName')]]</a>
            {{ELSE}}
              [[set.getVal('taskName')]]
            {{ENDIF}}
            [[Util::tickdone([[set.getVal('sumProgress')]], [[set.getVal('keyspace')]])]]
            {{IF [[set.getVal('isActive')]]}}
              <img src="static/active.gif" alt="Active">
            {{ENDIF}}
            {{IF [[set.getVal('isCpu')]] == 1}}
              <br>CPU only
            {{ENDIF}}
            {{IF [[set.getVal('isSmall')]] == 1}}
              <br>Small Task
            {{ENDIF}}
          </td>
          <td>
            {{IF [[login.getLevel()]] >= 5}}
              <a href="hashlists.php?id=[[set.getVal('hashlistId')]]">[[set.getVal('hashlistName')]]</a>
            {{ELSE}}
              [[set.getVal('hashlistName')]]
            {{ENDIF}}
            {{IF [[set.getVal('isSecret')]] == 1}}
              <img src="static/lock.gif" alt="Secret">
            {{ENDIF}}
            {{IF [[set.getVal('hashCount')]] == [[set.getVal('hashlistCracked')]]}}
              [[Util::tickdone(1, 1)]]
            {{ELSE}}
              [[Util::tickdone(0, 1)]]
            {{ENDIF}}
          </td>
          <td class="num">[[set.getVal('numChunks')]]@[[set.getVal('chunkTime')]]s</td>
          {{IF [[set.getVal('keyspace')]] > 0}}
            <td class='num'>
              [[Util::showperc([[set.getVal('taskProgress')]], [[set.getVal('keyspace')]])]]%
            </td>
            <td class='num'>
              [[Util::showperc([[set.getVal('sumProgress')]], [[set.getVal('keyspace')]])]]%
            </td>
          {{ELSE}}
            <td colspan='2'>Keyspace unknown</td>
          {{ENDIF}}
          <td class='num'>
            {{IF [[set.getVal('crackedCount')]] > 0 && [[login.getLevel()]] >= 5}}
              <a href="hashes.php?task=[[set.getVal('taskId')]]&filter=cracked">[[set.getVal('crackedCount')]]</a>
            {{ENDIF}}
            {{IF [[set.getVal('crackedCount')]] > 0 && [[login.getLevel()]] < 5}}
              [[set.getVal('crackedCount')]]
            {{ENDIF}}
          </td>
          <td class='num'>
            {{IF [[set.getVal('numAssignments')]] > 0}}
             [[set.getVal('numAssignments')]]
            {{ENDIF}}
          </td>
          <td style='min-width: 95px'>
            {{IF [[set.getVal('numFiles')]] > 0}}
              [[set.getVal('numFiles')]]
            {{ENDIF}}
            {{IF [[set.getVal('fileSecret')]]}}
              <img src="static/lock.gif" alt="Secret">
            {{ENDIF}}
            {{IF [[set.getVal('numFiles')]] > 0}}
              <br>([[Util::nicenum([[set.getVal('fileSizes')]])]]B)
            {{ENDIF}}
          </td>
          <td style='min-width: 130px'>
            {{IF [[login.getLevel()]] >= 20}}
              <form class="form-inline" action="tasks.php" method="POST">
                <input type='hidden' name='action' value='[[$DTaskAction::SET_PRIORITY]]'>
                <input type="hidden" name="task" value="[[set.getVal('taskId')]]">
                <input type="hidden" name="csrf" value="[[csrf]]">
                <input type="text" class='form-control' style='width: 60px;' name="priority" size="4" value="[[set.getVal('priority')]]" title="Priority">
                <input type="submit" class='btn btn-default' value="Set">
              </form>
            {{ELSE}}
              [[set.getVal('priority')]]
            {{ENDIF}}
          </td>
          <td style='min-width: 120px'>
            {{IF [[login.getLevel()]] >= 30}}
              <form style ='float: left; padding-right: 5px;' action="tasks.php?new=true&copy=[[set.getVal('taskId')]]" method="post">
                <input type="submit" class='btn btn-default' value="Copy">
              </form>
              <form style ='float: left;' action="tasks.php" method="POST" onSubmit="if (!confirm('Really delete task [[set.getVal('taskId')]]?')) return false;">
                <input type="hidden" name="action" value="[[$DTaskAction::DELETE_TASK]]">
                <input type="hidden" name="task" value="[[set.getVal('taskId')]]">
                <input type="hidden" name="csrf" value="[[csrf]]">
                <input type="submit" class='btn btn-danger' value="X">
              </form>
            {{ENDIF}}
          </td>
        </tr>
        {{IF [[set.getVal('sumProgress')]] < [[set.getVal('keyspace')]]}}
          <tr>
            <td colspan="11" style="padding: 0px 1px;">
              <img style="width: 100%; height: 6px; padding: 0px;" src="api/taskimg.php?task=[[set.getVal('taskId')]]&x=1200&y=6">
            </td>
				  </tr>
				{{ENDIF}}
			{{ELSE}}
				<!-- supertask -->
        <tr style="background-color: rgba(0,0,0,0.1);">
          <td>&nbsp;</td>
          <td>
            [[set.getVal('supertaskName')]]
            [[Util::tickdone([[set.getVal('tasksDone')]], [[set.getVal('numTasks')]])]]
            {{IF [[set.getVal('isActive')]] == 1 && [[set.getVal('tasksDone')]] < [[set.getVal('numTasks')]]}}
              <img src="static/active.gif" alt="Active">
            {{ENDIF}}
          </td>
          <td>
            {{IF [[login.getLevel()]] >= 5}}
              <a href="hashlists.php?id=[[set.getVal('hashlistId')]]">[[set.getVal('hashlistName')]]</a>
            {{ELSE}}
              [[set.getVal('hashlistName')]]
            {{ENDIF}}
            {{IF [[set.getVal('hashlistSecret')]] == 1}}
              <img src="static/lock.gif" alt="Secret">
            {{ENDIF}}
            {{IF [[set.getVal('hashCount')]] == [[set.getVal('hashlistCracked')]]}}
              [[Util::tickdone(1, 1)]]
            {{ELSE}}
              [[Util::tickdone(0, 1)]]
            {{ENDIF}}
          </td>
          <td colspan="3">Supertask</td>
          <td class='num'>
            {{IF [[set.getVal('cracked')]] > 0 && [[login.getLevel()]] < 5}}
              [[set.getVal('cracked')]]
            {{ENDIF}}
          </td>
          <td class='num'>
            {{IF [[set.getVal('numAssignments')]] > 0}}
              [[set.getVal('numAssignments')]]
            {{ENDIF}}
          </td>
          <td style='min-width: 95px'>
            {{IF [[set.getVal('numFiles')]] > 0}}
              [[set.getVal('numFiles')]]
            {{ENDIF}}
            {{IF [[set.getVal('fileSecret')]]}}
              <img src="static/lock.gif" alt="Secret">
            {{ENDIF}}
            {{IF [[set.getVal('numFiles')]] > 0}}
              <br>([[Util::nicenum([[set.getVal('filesSize')]])]]B)
            {{ENDIF}}
          </td>
          <td style='min-width: 130px'>
            {{IF [[login.getLevel()]] >= 20}}
              <form class="form-inline" action="tasks.php" method="POST">
                <input type='hidden' name='action' value='[[$DTaskAction::SET_SUPERTASK_PRIORITY]]'>
                <input type="hidden" name="supertaskId" value="[[set.getVal('taskWrapperId')]]">
                <input type="hidden" name="csrf" value="[[csrf]]">
                <input type="text" class='form-control' style='width: 60px;' name="priority" size="4" value="[[set.getVal('priority')]]" title="Priority">
                <input type="submit" class='btn btn-default' value="Set">
              </form>
            {{ELSE}}
              [[set.getVal('priority')]]
            {{ENDIF}}
          </td>
          <td style='min-width: 120px'>
            {{IF [[task.getVal('Task').getTaskType()]] == 1}}
              <form style ='float: left; padding-right: 5px;'>
                <a class="btn btn-primary accordion-toggle" onclick="expansionCheck('#task[[set.getVal('taskWrapperId')]]')" role="button" href="#" data-toggle="collapse" data-target="#task[[set.getVal('taskWrapperId')]]">Show/Hide</a>
              </form>
              <script type="text/javascript">
                  $( document ).ready(function() {
                      checkOnLoading("#task[[set.getVal('taskWrapperId')]]");
                  });
              </script>
            {{ENDIF}}
            {{IF [[login.getLevel()]] >= 30}}
              <form style ='float: left;' action="tasks.php" method="POST" onSubmit="if (!confirm('Really delete supertask [[set.getVal('taskWrapperId')]]?')) return false;">
                <input type="hidden" name="action" value="[[$DTaskAction::DELETE_SUPERTASK]]">
                <input type="hidden" name="supertaskId" value="[[set.getVal('taskWrapperId')]]">
                <input type="hidden" name="csrf" value="[[csrf]]">
                <input type="submit" class='btn btn-danger' value="X">
              </form>
            {{ENDIF}}
          </td>
        </tr>
        <tr style="background-color: rgba(0,0,0,0.1);" data-toggle="collapse" data-target="#task[[set.getVal('taskWrapperId')]]" class="accordion-toggle">
          <td colspan="11" style="padding: 0px 1px;">
            <img style="width: 100%; height: 6px; padding: 0px;" src="api/taskimg.php?supertask=[[set.getVal('taskWrapperId')]]&x=1200&y=6">
          </td>
        </tr>
        <tr>
          <td colspan="11" class="hiddenRow">
            <div id="task[[set.getVal('taskWrapperId')]]" class="accordian-body collapse" style="margin: 10px;" aria-expanded="false">
              <div class="panel panel-default" style="margin-bottom: 0;">
                <table class="table table-bordered table-nonfluid table-subtask-border">
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Chunks</th>
                    <th>Dispatched</th>
                    <th>Searched</th>
                    <th>Cracked</th>
                    <th>Agents</th>
                    <th>Files</th>
                    <th>Subtask Priority</th>
                    <th>Action</th>
                  </tr>
                  {{FOREACH subTask;[[subTaskList]]}}
                    <tr>
                      <td{{IF [[strlen([[subTask.getVal('color')]])]] > 0}} style="background-color: #[[subTask.getVal('color')]]"{{ENDIF}}>
                      {{IF [[login.getLevel()]] >= 5}}
                        <a href="tasks.php?id=[[subTask.getVal('taskId')]]">[[subTask.getVal('taskId')]]</a>
                      {{ELSE}}
                        [[subTask.getVal('taskId')]]
                      {{ENDIF}}
                      </td>
                      <td title="[[htmlentities([[subTask.getVal('attackCmd')]], ENT_QUOTES, 'UTF-8')]]">
                        {{IF [[login.getLevel()]] >= 5}}
                          <a href="tasks.php?id=[[subTask.getVal('taskId')]]">[[subTask.getVal('taskName')]]</a>
                        {{ELSE}}
                          [[subTask.getVal('taskName')]]
                        {{ENDIF}}
                        [[Util::tickdone([[subTask.getVal('sumProgress')]], [[subTask.getVal('keyspace')]])]]
                        {{IF [[subTask.getVal('isActive')]] == 1 && [[subTask.getVal('sumProgress')]] < [[subTask.getVal('keyspace')]]}}
                          <img src="static/active.gif" alt="Active">
                        {{ENDIF}}
                        {{IF [[subTask.getVal('cpuOnly')]] == 1}}
                          <br>CPU only
                        {{ENDIF}}
                        {{IF [[subTask.getVal('isSmall')]] == 1}}
                          <br>Small Task
                        {{ENDIF}}
                      </td>
                      <td class="num">[[subTask.getVal('numChunks')]]@[[subTask.getVal('chunkTime')]]s</td>
                      {{IF [[subTask.getVal('keyspace')]] > 0}}
                        <td class='num'>
                          [[Util::showperc([[subTask.getVal('taskProgress')]], [[subTask.getVal('keyspace')]])]]%
                        </td>
                        <td class='num'>
                          [[Util::showperc([[subTask.getVal('sumProgress')]], [[subTask.getVal('keyspace')]])]]%
                        </td>
                      {{ELSE}}
                        <td colspan='2'>Keyspace unknown</td>
                      {{ENDIF}}
                      <td class='num' style="min-width: 50px;">
                        {{IF [[subTask.getVal('cracked')]] > 0 && [[login.getLevel()]] >= 5}}
                          <a href="hashes.php?task=[[subTask.getVal('taskId')]]&filter=cracked">[[subTask.getVal('cracked')]]</a>
                        {{ENDIF}}
                        {{IF [[subTask.getVal('cracked')]] > 0 && [[login.getLevel()]] < 5}}
                          [[subTask.getVal('cracked')]]
                        {{ENDIF}}
                      </td>
                      <td class='num' style="min-width: 50px;">
                        {{IF [[subTask.getVal('numAssignments')]] > 0}}
                          [[subTask.getVal('numAssignments')]]
                        {{ENDIF}}
                      </td>
                      <td style='min-width: 95px'>
                        {{IF [[subTask.getVal('numFiles')]] > 0}}
                          [[subTask.getVal('numFiles')]]
                        {{ENDIF}}
                        {{IF [[subTask.getVal('fileSecret')]]}}
                          <img src="static/lock.gif" alt="Secret">
                        {{ENDIF}}
                        {{IF [[subTask.getVal('numFiles')]] > 0}}
                          <br>([[Util::nicenum([[subTask.getVal('filesSize')]])]]B)
                        {{ENDIF}}
                      </td>
                      <td style='min-width: 130px'>
                        {{IF [[login.getLevel()]] >= 20}}
                          <form class="form-inline" action="tasks.php" method="POST">
                            <input type='hidden' name='action' value='[[$DTaskAction::SET_PRIORITY]]'>
                            <input type="hidden" name="task" value="[[subTask.getVal('taskId')]]">
                            <input type="hidden" name="csrf" value="[[csrf]]">
                            <input type="text" class='form-control' style='width: 60px;' name="priority" size="4" value="[[subTask.getVal('priority')]]" title="Priority">
                            <input type="submit" class='btn btn-default' value="Set">
                          </form>
                        {{ELSE}}
                          [[subTask.getVal('Task')->getPriority()]]
                        {{ENDIF}}
                      </td>
                      <td style='min-width: 120px'>
                        {{IF [[login.getLevel()]] >= 30}}
                          <form style ='float: left; padding-right: 5px;' action="tasks.php?new=true&copy=[[subTask.getVal('taskId')]]" method="post">
                            <input type="submit" class='btn btn-default' value="Copy">
                          </form>
                          <form style ='float: left;' action="tasks.php" method="POST" onSubmit="if (!confirm('Really delete task [[subTask.getVal('taskId')]]?')) return false;">
                            <input type="hidden" name="action" value="[[$DTaskAction::DELETE_TASK]]">
                            <input type="hidden" name="csrf" value="[[csrf]]">
                            <input type="hidden" name="task" value="[[subTask.getVal('taskId')]]">
                            <input type="submit" class='btn btn-danger' value="X">
                          </form>
                        {{ENDIF}}
                      </td>
                    </tr>
                    {{IF [[subTask.getVal('sumProgress')]] < [[subTask.getVal('keyspace')]]}}
                    <tr>
                      <td colspan="11" style="padding: 0px 1px;">
                        <img style="width: 100%; height: 6px; padding: 0px;" src="api/taskimg.php?task=[[subTask.getVal('taskId')]]&x=1200&y=6">
                      </td>
                    </tr>
                    {{ENDIF}}
                  {{ENDFOREACH}}
                </table>
              </div>
            </div>
          </td>
        </tr>
        {{ENDIF}}
			{{ENDIF}}
    {{ENDFOREACH}}
  </table>
</div>
{%TEMPLATE->struct/foot%}